Mise à jour du firmware et accès aux logs, sans port série.

Jusqu\textquotesingle{}ici notre objet connecté est resté relité à notre ordinateur via un câble USB pour le téléversement du code et l\textquotesingle{}accès aux messages, le tout via le port série. Très bien, mais un objet connecté a vocation à être débranché du câble USB qui le relie à un ordinateur et vivre sa vie à distance et en tout autonomie. \hypertarget{ota_updateOTA}{}\doxysubsection{Mise à jour du firmware}\label{ota_updateOTA}
Toutefois, une déconnecté de l\textquotesingle{}ordinateur, avec une alimentation électrique et le réseau Wi\+Fi, comme réaliser des mises à jour du firmware sans port série ? Avec la bibliothèque {\bfseries{Over The Air}} ! Cette dernière permet d\textquotesingle{}ajouter des ports réseau en plus des ports série et de téléverser via l\textquotesingle{}IDE Arduino de la même façon.

Lorsque vous téléverser votre nouveau code à distance, la carte enregistre votre nouveau code dans sa mémoire alors que le code actuel est toujours présent et actif. Une fois le téléchargement terminé alors la carte redémarre, installe et éxecute votre nouveau code. Cela nécessite donc d\textquotesingle{}avoir dimensionné votre espace mémoire de façon à pouvoir stocker le nouveau code. 

\begin{DoxyNote}{Note}
Avant de téléverser ce programme pour la première fois via la liaison série, vérifier dans le menu \char`\"{}\+Outils\char`\"{} que la \char`\"{}\+Flash size\char`\"{} sélectionnée correspond bien à votre matériel. Classiquement pour un ESP32, il faut renseigner 4M (1M SPIFFS); on maximise ainsi l\textquotesingle{}espace disponible pour OTA, cf. spiffs . Au regard de la taille de votre programme et de vos données dans le SPIFFS, vous pouvez également sélectionner le mode Minimal SPIFFS (1.\+9 MB App with OTA/190 KB SPIFFS).
\end{DoxyNote}
Pour éviter que toute personne ayant accès au réseau Wi\+Fi sur lequel est branché votre objet puisse téléverser un nouveau firmware, il est préférable d\textquotesingle{}ajouter un peu de sécurité en demandant un mot de passe lors des mises à jour.\hypertarget{ota_remote}{}\doxysubsection{Debug à distance}\label{ota_remote}
S\textquotesingle{}affranchir de la liaison série est appréciable, toutefois on perd en même temps une fonctionnalité très utile \+: l\textquotesingle{}affichage des messages de debug ! Une solution pour palier à ce problème est l\textquotesingle{}utilisation de la bibliothèque Remote\+Debug qui permet de se connecter en telnet à notre carte et de récupérer les messages par ce biais.

\begin{DoxyNote}{Note}
{\bfseries{Tous}} les messages de debug qui sont présents dans votre code doivent être modifiés pour appeler les fonctions de génération de debug de la bibliothèque Remote\+Debug.
\end{DoxyNote}
Il y a possibilités de créer des messages avec différents niveaux de logs, les voici par niveau de détail \+:
\begin{DoxyItemize}
\item Verbose
\item Debug
\item Info
\item Warnings
\item Errors Quand vous sélectionner un niveau de détail, tous les messages de niveau \char`\"{}inférieur\char`\"{} sont également visibles.
\end{DoxyItemize}

Une fois ce firmware téléversé\+:
\begin{DoxyItemize}
\item Dans le menu \char`\"{}\+Outils/\+Port\char`\"{}, vérifier que le nouveau port $<$\+OTA\+\_\+\+HOSTNAME$>$ at $<$\+IP ADDRESS$>$ apparaît dans la liste des \char`\"{}\+Ports réseau\char`\"{}.
\item Si tel est le cas, vous pouvez débrancher votre objet du port série de votre ordinateur et le brancher à une autre source d\textquotesingle{}alimentation.
\item Il n\textquotesingle{}apparait donc plus dans la liste de vos \char`\"{}\+Ports série\char`\"{} mais est toujours présent dans les \char`\"{}\+Ports réseau\char`\"{}.
\item Vous pouvez désormais téléversez vos nouveaux firmwares {\bfseries{Over}} {\bfseries{The}} {\bfseries{Air}}.
\item Pour accéder aux logs, 2 possibilités \+:
\begin{DoxyItemize}
\item Ouvrez un terminal et saisissez \char`\"{}telnet $<$adresse IP$>$\char`\"{} pour y voir apparaître vos messages de logs, ou utilisez un logiciel du type Putty \+: \href{https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html}{\texttt{ https\+://www.\+chiark.\+greenend.\+org.\+uk/$\sim$sgtatham/putty/latest.\+html}}
\item Remote Debug embarque une bibliothèque de web socket qui permet d\textquotesingle{}accéder aux logs. Télécharger la Web App (le zip décompressé de \href{https://github.com/JoaoLopesF/RemoteDebugApp}{\texttt{ https\+://github.\+com/\+Joao\+Lopes\+F/\+Remote\+Debug\+App}}) sur votre ordinateur et lancer index.\+html pour pouvoir vous connecter à votre carte à l\textquotesingle{}aide d\textquotesingle{}une web socket et récupérer les logs.
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{ota_otalib}{}\doxysubsection{Librairies nécessaires}\label{ota_otalib}
Bibliothèques à installer pour utiliser ce module \+:
\begin{DoxyItemize}
\item Arduino OTA by Arduino Juraj Andrassy \+: \href{https://github.com/jandrassy/ArduinoOTA}{\texttt{ https\+://github.\+com/jandrassy/\+Arduino\+OTA}}
\item Remote\+Debug by Joao Lopez \+: \href{https://github.com/JoaoLopesF/RemoteDebug}{\texttt{ https\+://github.\+com/\+Joao\+Lopes\+F/\+Remote\+Debug}}
\end{DoxyItemize}

\begin{DoxyNote}{Note}
Vous devriez rencontrer une erreur de compilation du type \begin{DoxyVerb}.../libraries/RemoteDebug/src/utility/WebSockets.cpp:42:10: fatal error: hwcrypto/sha.h: No such file or directory\end{DoxyVerb}
 Si c\textquotesingle{}est le cas, pour corriger le problème, éditez le fichier en question et remplacer hwcrypto/sha.\+h par sha/sha\+\_\+parallel\+\_\+engine.\+h !
\end{DoxyNote}
Fichier \mbox{\hyperlink{_my_o_t_a_8h}{My\+OTA.\+h}} 